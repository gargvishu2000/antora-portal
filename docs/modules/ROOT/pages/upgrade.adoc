= Plain Portal Upgrade process
Active Intelligence Platform
:title-logo-image: image:/theme/logo.png[pdfwidth=3.5in,align=right]
:revnumber: v0.1.1
:doctype: book
:encoding: utf-8
:lang: en
:numbered:
:icons: font
:source-highlighter: rouge
:sectnumlevels: 5
:toc: left
:chapter-label:


== Introduction

This document details the portal upgrade process.

== Portal upgrade

The next steps will use xref:install.adoc#_install_portal_eg[this] as base for the upgrade scenario.

[#_portal_config]
=== Create and upload Portal upgrade configurations

Upload portal config into *upgrade* directory.

Make sure to:

* *remove* the properties:

[source,xml]
----
<array name="AreaReRouting"/>
<string name="InstanceName"/>
----

* *add* the property:

[source,xml]
----
<composite output-type="String" name="WebServerHost">${env.DEPLOYMENT_NAME}</composite>
----

Example:

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<ic:instance-config xmlns:ic="urn:wedo:infra:instance-config-2.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<global>
		<string name="DbHost">postgres</string>
		<int name="DbPort">5432</int>
		<string name="DbDatabase">postgres</string>
		<string name="DbRdbms">Postgresql</string>
        <string name="DbUsersDbaUser">postgres</string>
        <string name="DbUsersDbaPwd">postgres</string>
        <string name="DbUsersAppUser">PORTALAPP</string>
        <string name="DbUsersAppPwd">PORTALAPP</string>
        <string name="DbUsersAdmUser">PORTALADM</string>
		<string name="DbUsersAdmPwd">PORTALADM</string>
		<string name="CompanyWebIdentifier">mobileum.com</string>
		<string name="ServerAdminPwd">Password1</string>
		<string name="ServerInternalPwd">Password1</string>
        <string name="DbTablespacesSmallData">PG_DEFAULT</string>
        <string name="DbTablespacesMediumData">PG_DEFAULT</string>
        <string name="DbTablespacesLargeData">PG_DEFAULT</string>
        <string name="DbTablespacesLOB">PG_DEFAULT</string>
        <string name="DbTablespacesSmallIndex">PG_DEFAULT</string>
        <string name="DbTablespacesMediumIndex">PG_DEFAULT</string>
        <string name="DbTablespacesLargeIndex">PG_DEFAULT</string>
        <string name="DbTablespacesDefault">PG_DEFAULT</string>
		<string name="DbTablespacesTemp">PG_DEFAULT</string>
        <int name="WebServerPort">8080</int> <!-- Can't be changed -->
		<int name="WebServerShutdownPort">8081</int> <!-- Can't be changed -->
		<string name="ServerMemoryOptions">-Xms128M -Xmx1024M -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:MaxPermSize=256m</string>
        <composite name="WebServerHost">${env.DEPLOYMENT_NAME}</composite>
	</global>
</ic:instance-config>
----

[source,shell]
----
aws s3 cp product-config.xml s3://mybucket/example/portal/upgrade/
----

Get a product license and upload it into upgrade directory.

[source,shell]
----
$ aws s3 cp license.lic s3://mybucket/example/portal/upgrade/
----

=== Create and upload Portal startup configurations

Upload the previous portal config and license to startup and cleanup directories.

[source,bash]
----
aws s3 cp product-config.xml s3://mybucket/example/portal/startup/
aws s3 cp license.lic s3://mybucket/example/portal/startup/

aws s3 cp product-config.xml s3://mybucket/example/portal/cleanup/
aws s3 cp license.lic s3://mybucket/example/portal/cleanup/
----

=== Upgrade Portal

[source,bash]
----
helm upgrade portal \
  --set deployment.name=portal \
  --set image.registry="162015117822.dkr.ecr.eu-west-1.amazonaws.com" \
  --set image.repository="aip/portal-8.2.5_220930" \ <1>
  --set image.tag="0.4.4" \ <1>
  --timeout 30m \
  <PATH_TO_BUNDLE>/charts/ \
  --version "0.4.4" <2>
----

<1> Example of newer image and tag.
<2> Example of newer chart version.

[WARNING]
If you perform an upgrade without changing the image, you need to restart your deployment in order to fetch the new registry from the storage. This can be done by executing `kubectl scale deployment portal --replicas=0 && kubectl scale deployment portal --replicas=1`.